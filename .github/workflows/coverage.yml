name: ðŸ“Š Code Coverage Report

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  coverage:
    name: Generate Coverage Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, zip, pcov
          tools: composer:v2
          coverage: pcov

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ~/.local/share/pnpm/store/v3
          key: ${{ runner.os }}-pnpm-coverage-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            vendor
          key: ${{ runner.os }}-coverage-${{ hashFiles('**/composer.lock') }}

      - name: Install PHP dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: Install Node.js dependencies
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Start wp-env
        run: npx --yes @wordpress/env@10.33.0 start

      - name: Run tests with coverage
        run: pnpm test:coverage

      - name: Stop wp-env
        if: always()
        run: npx --yes @wordpress/env@10.33.0 stop || true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: coverage/clover.xml
          flags: unittests
          name: PHP Coverage
          fail_ci_if_error: false

      - name: Generate coverage badges
        if: github.event_name == 'push'
        run: |
          # Generate coverage badge
          if [ -f coverage/clover.xml ]; then
            COVERAGE=$(php -r "
              \$xml = simplexml_load_file('coverage/clover.xml');
              \$metrics = \$xml->project->metrics;
              \$percentage = round((\$metrics['coveredstatements'] / \$metrics['statements']) * 100, 1);
              echo \$percentage;
            ")
            echo "Coverage: ${COVERAGE}%"
            echo "COVERAGE_PERCENTAGE=${COVERAGE}" >> \$GITHUB_ENV
          fi

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request' && env.COVERAGE_PERCENTAGE
        uses: dorny/test-reporter@v1
        with:
          name: PHPUnit Coverage
          path: coverage/junit.xml
          reporter: java-junit
          fail-on-error: false

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ github.run_id }}
          path: |
            coverage/
          retention-days: 30
