name: CI/CD Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  COMPOSER_NO_INTERACTION: 1
  PNPM_CACHE_FOLDER: ~/.pnpm-store
  PLUGIN_SLUG: campaignbridge

jobs:
  # Fast CI pipeline - quality, build, test all in one
  ci:
    name: üöÄ CI Pipeline
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php: ['8.2']  # Single PHP version for speed
        include:
          - php: '8.2'
            coverage: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring, xml, zip, xdebug
          tools: composer:v2, phpcs, phpstan
          coverage: xdebug

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.composer/cache
            vendor
            ~/.local/share/pnpm/store/v3
          key: ${{ runner.os }}-ci-${{ hashFiles('**/composer.lock', '**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-ci-

      - name: Install PHP dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader --no-progress

      - name: Install Node.js dependencies
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Setup WordPress Testing Suite
        run: |
          # Download WordPress core for testing
          wget -O wordpress.zip https://wordpress.org/latest.zip
          unzip -q wordpress.zip
          mv wordpress wordpress-core

          # Setup test database
          mysql -e 'CREATE DATABASE wordpress_test;' -uroot -proot
          mysql -e "GRANT ALL PRIVILEGES ON wordpress_test.* TO 'root'@'localhost';" -uroot -proot

      - name: Code Quality Checks
        run: |
          echo "üîç Running quality checks..."
          pnpm lint:php || exit 1
          pnpm lint:js || exit 1
          pnpm format:check || exit 1
          pnpm phpstan || exit 1
          pnpm security:check || exit 1

      - name: Build Assets
        run: pnpm build

      - name: Run Tests with WordPress Core Suite
        run: |
          # Use WordPress core testing instead of wp-env
          export WP_TESTS_DIR=/home/runner/work/CampaignBridge/CampaignBridge/wordpress-core/tests/phpunit
          export WP_CORE_DIR=/home/runner/work/CampaignBridge/CampaignBridge/wordpress-core
          pnpm test${{ matrix.coverage && ':coverage' || '' }} || exit 1
        env:
          WP_TESTS_DOMAIN: localhost
          WP_TESTS_EMAIL: admin@example.org
          WP_TESTS_TITLE: Test Blog

      - name: Upload Coverage
        if: matrix.coverage
        uses: codecov/codecov-action@v4
        with:
          file: coverage/clover.xml
          flags: unittests
          name: PHP Coverage
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  # Release on main/master
  release:
    name: üöÄ Release
    runs-on: ubuntu-latest
    needs: ci
    if: success() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name == 'push'
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.local/share/pnpm/store/v3
          key: ${{ runner.os }}-release-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Create Release Zip
        run: |
          # Clean up for production
          rm -rf node_modules/ tests/ .github/ .git/ coverage/ vendor/
          rm -f *.lock *.log .editorconfig .eslintignore .eslintrc* .prettier*
          rm -f .phpstan* phpcs.xml* phpunit.xml* tsconfig.json webpack*.config.*
          rm -f postcss.config.* *.config.js *.config.mjs
          rm -rf src/

          # Create zip
          zip -r ../${{ env.PLUGIN_SLUG }}.zip . -x "*.git*" "*.DS_Store" "*.log"

      - name: Semantic Release
        run: pnpm semantic-release || echo "No release needed"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
