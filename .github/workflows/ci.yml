name: CI/CD Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  COMPOSER_NO_INTERACTION: 1
  PNPM_CACHE_FOLDER: ~/.pnpm-store
  PLUGIN_SLUG: campaignbridge

jobs:
  # Fast CI pipeline - quality, build, test all in one
  ci:
    name: ðŸš€ CI Pipeline
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php: ['8.2']  # Single PHP version for speed
        include:
          - php: '8.2'
            coverage: true

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wordpress_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring, xml, zip, xdebug
          tools: composer:v2, phpcs, phpstan, cs2pr
          coverage: xdebug

      - name: Install Subversion
        run: sudo apt-get update && sudo apt-get install -y subversion

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.composer/cache
            vendor
            ~/.local/share/pnpm/store/v3
          key: ${{ runner.os }}-ci-${{ hashFiles('**/composer.lock', '**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-ci-

      - name: Install PHP dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader --no-progress

      - name: Install Node.js dependencies
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Setup WordPress Testing Suite
        run: |
          # Setup WordPress testing environment using standard script
          echo "Running install-wp-tests.sh..."
          bash bin/install-wp-tests.sh wordpress_test root root 127.0.0.1:3306 latest true

          # Check if setup was successful
          echo "Checking WordPress test setup..."
          ls -la /tmp/wordpress-tests-lib/ || echo "âœ— Test library not created"

          if [ -f /tmp/wordpress-tests-lib/wp-tests-config.php ]; then
            echo "âœ“ wp-tests-config.php found in test library"
            cp /tmp/wordpress-tests-lib/wp-tests-config.php ./wp-tests-config.php
            echo "âœ“ Copied wp-tests-config.php to project root"
            ls -la wp-tests-config.php
          else
            echo "âœ— wp-tests-config.php not created by install-wp-tests.sh"
            echo "Checking if sample file exists..."
            ls -la /tmp/wordpress-tests-lib/wp-tests-config-sample.php || echo "Sample file also missing"

            # Try to create config manually
            echo "Creating wp-tests-config.php manually..."
            cat > ./wp-tests-config.php << 'EOF'
<?php
/* Path to the WordPress codebase you'd like to test. Add a forward slash in the end. */
define( 'ABSPATH', '/tmp/wordpress/' );

// Test with multisite enabled.
// Alternatively, use the tests/phpunit/multisite.xml configuration file.
// define( 'WP_TESTS_MULTISITE', true );

// Force known bugs to be run.
// Tests with an associated Trac ticket that is still open are normally skipped.
// define( 'WP_TESTS_FORCE_KNOWN_BUGS', true );

// Test with WordPress debug mode (default).
define( 'WP_DEBUG', true );

// ** MySQL settings ** //

// This configuration file will be used by the copy of WordPress being tested.
// wordpress_test is the name of the test database that will be created.
// It will be dropped and recreated each time the test suite runs, so it should be a test-only database.

// Hostname:port combination.
define( 'DB_HOST', '127.0.0.1:3306' );

// Database name (same as passed to install-wp-tests.sh)
define( 'DB_NAME', 'wordpress_test' );

define( 'DB_USER', 'root' );
define( 'DB_PASSWORD', 'root' );

// Database charset (set to utf8mb4 when testing 5.0+)
define( 'DB_CHARSET', 'utf8mb4' );
define( 'DB_COLLATE', '' );

// ** Test settings ** //

// These should be equivalent to the WordPress installation you're testing.
define( 'WP_TESTS_DOMAIN', 'localhost' );
define( 'WP_TESTS_EMAIL', 'admin@example.org' );
define( 'WP_TESTS_TITLE', 'Test Blog' );

// ** Settings to create the database tables ** //
define( 'WP_TESTS_CONFIG_FILE_PATH', '/tmp/wordpress/wp-tests-config.php' );

// Should be equivalent to the WordPress installation you're testing.
define( 'WP_PHP_BINARY', 'php' );
EOF
            echo "âœ“ Created wp-tests-config.php manually"
            ls -la wp-tests-config.php
          fi

      - name: Code Quality Checks
        run: |
          echo "ðŸ” Running quality checks..."
          ./vendor/bin/phpcs --standard=phpcs.xml.dist includes/ src/ || exit 1
          npx eslint --max-warnings 0 src/ || exit 1
          pnpm format:check || exit 1
          ./vendor/bin/phpstan analyse --memory-limit=2G --verbose || exit 1
          find includes/ -name "*.php" -exec php -l {} \; && echo "PHP syntax check passed" || exit 1

      - name: Build Assets
        run: pnpm build

      - name: Run Tests with WordPress Core Suite
        run: |
          # Use standard WordPress testing environment set up by install-wp-tests.sh
          ./vendor/bin/phpunit --configuration=phpunit.xml.dist --coverage-html=coverage --coverage-text --verbose || exit 1
        env:
          WP_TESTS_DOMAIN: localhost
          WP_TESTS_EMAIL: admin@example.org
          WP_TESTS_TITLE: Test Blog
          WP_TESTS_DB_HOST: 127.0.0.1:3306

      - name: Upload Coverage
        if: matrix.coverage
        uses: codecov/codecov-action@v4
        with:
          file: coverage/clover.xml
          flags: unittests
          name: PHP Coverage
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  # Release on main/master
  release:
    name: ðŸš€ Release
    runs-on: ubuntu-latest
    needs: ci
    if: success() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name == 'push'
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.local/share/pnpm/store/v3
          key: ${{ runner.os }}-release-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Create Release Zip
        run: |
          # Clean up for production
          rm -rf node_modules/ tests/ .github/ .git/ coverage/ vendor/
          rm -f *.lock *.log .editorconfig .eslintignore .eslintrc* .prettier*
          rm -f .phpstan* phpcs.xml* phpunit.xml* tsconfig.json webpack*.config.*
          rm -f postcss.config.* *.config.js *.config.mjs
          rm -rf src/

          # Create zip
          zip -r ../${{ env.PLUGIN_SLUG }}.zip . -x "*.git*" "*.DS_Store" "*.log"

      - name: Semantic Release
        run: pnpm semantic-release || echo "No release needed"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
